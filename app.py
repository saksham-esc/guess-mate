# Guess Mate - Flask Application with Gemini AI Integration
# This application implements a guessing game where AI asks questions to guess an object.

import os
import asyncio
import google.generativeai as genai
from flask import Flask, request, render_template, session, redirect, url_for
from dotenv import load_dotenv

# Load environment variables from .env file
load_dotenv()

# Flask Application Setup
app = Flask(__name__)
app.secret_key = os.getenv("FLASK_SECRET_KEY", "supersecretkey")

# AI Configuration
api_key = os.getenv("GOOGLE_API_KEY")
genai.configure(api_key=api_key)
model = genai.GenerativeModel("gemini-2.0-flash")  # Gemini 2.0 Flash model for fast responses

# Game Constants
MAX_QUESTIONS = 20

# Route Handling: Index Route
# Handles the home page where users start the game.
# Supports both GET and POST for flexibility, though currently only renders the template.
@app.route("/", methods=["GET", "POST"])
async def index():
    return render_template("index.html")

# Route Handling: Play Route
# Core game logic route handling GET and POST requests.
# Manages game state transitions, AI question generation, and rendering appropriate templates.
@app.route("/play", methods=["GET", "POST"])
async def play():
    # Session Management: Initialize game state if not present
    if "qnum" not in session:
        session["qnum"] = 0
        session["questions"] = []
        session["answers"] = []

    # Handle POST requests for user actions
    if request.method == "POST":
        if session["qnum"] == 0 and request.form.get("answer") == "start":
            session["qnum"] = 1
            # AI Interaction: Generate first question
            prompt = "Ask a concise yes/no/I don't know question about an object. Do not include any description or explanation."
            response = await asyncio.to_thread(model.generate_content, prompt)
            question = response.text.strip()
            session["questions"].append(question)
            return render_template("play.html", question=question, qnum=1, MAX_QUESTIONS=MAX_QUESTIONS)
        elif session["qnum"] > 0:
            answer = request.form.get("answer")
            session["answers"].append(answer)
            session["qnum"] += 1

    qnum = session["qnum"]

    # Game State Machine: Check if game should end
    if qnum > MAX_QUESTIONS:
        # AI Interaction: Generate final guess
        prompt = "Based on these questions and answers, guess the object. Respond with only the object name, no explanation.\n"
        for i, (q, a) in enumerate(zip(session["questions"], session["answers"])):
            prompt += f"Q{i+1}: {q} A{i+1}: {a}\n"
        response = await asyncio.to_thread(model.generate_content, prompt)
        guess = response.text.strip()
        # Calculate score: max 100, deduct 5 per question
        score = max(0, 100 - (qnum - 1) * 5)
        session.clear()  # Clear session after game end
        return render_template("results.html", answer=guess, score=score, mode="game")

    # Game State Machine: Idle state
    if qnum == 0:
        return render_template("play.html", question="", qnum=0, MAX_QUESTIONS=MAX_QUESTIONS)

    # AI Interaction: Generate next question
    if qnum == 1:
        question = session["questions"][0]
    else:
        prompt = "Based on previous questions and answers, ask the next concise yes/no/I don't know question without any description or explanation.\n"
        for i, (q, a) in enumerate(zip(session["questions"], session["answers"])):
            prompt += f"Q{i+1}: {q} A{i+1}: {a}\n"
        response = await asyncio.to_thread(model.generate_content, prompt)
        question = response.text.strip()
        session["questions"].append(question)

    return render_template("play.html", question=question, qnum=qnum, MAX_QUESTIONS=MAX_QUESTIONS)



if __name__ == "__main__":
    app.run(debug=True) 


































































































        





























































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































